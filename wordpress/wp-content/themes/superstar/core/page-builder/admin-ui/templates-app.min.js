!function(a){"use strict";wp.media.model.BtItems=Backbone.Collection.extend({props:new Backbone.Model({item:""}),model:Backbone.Model.extend({defaults:{type:"",group:"all"}})})}(jQuery),function(a){"use strict";wp.media.controller.BtTemplates=wp.media.controller.State.extend({defaults:{id:"bt-local",menu:"default",type:"",toolbar:"bt-select"},initialize:function(){var a=this.get("data").items,b=this.get("library"),c=this.get("selection");b instanceof wp.media.controller.BtTemplates.Library||(b=new wp.media.controller.BtTemplates.Library(a),b.props.on("change",this.BtResetLibrary,this),this.set("library",b)),c instanceof wp.media.model.Selection||this.set("selection",new wp.media.model.Selection(c,{multiple:!1}))},activate:function(){this.frame.on("open",this.refresh,this)},deactivate:function(){this.frame.off("open",this.refresh,this)},refresh:function(){this.BtResetFilter(),this.BtUpdateSelection()},BtFetchItems:function(){var a=this.get("library");a.items.fetch({reset:!0,url:ajaxurl,data:{action:"bt_fetch_template_items",template_type:this.get("type")}}),this.set("library",a)},BtResetLibrary:function(){var a=this.get("library"),b=a.props.get("group"),c=this.frame.BtGetCurrentItem();c.set("group",b),a.reInitialize(),this.set("library",a),this.BtUpdateSelection()},BtResetFilter:function(){var a=this.get("library"),b=this.frame.BtGetCurrentItem(),c=[],d=b.get("group");_.isUndefined(c[d])&&(d="all"),a.props.set("group",d),a.props.set("search","")},BtUpdateSelection:function(){var a,b=this.get("selection"),c=this.get("type"),d=c+"-icon",e=this.frame.BtGetCurrentItem(),f=e.get(d);c===e.get("type")&&f&&(a=this.get("library").findWhere({id:f})),b.reset(a?a:[])},btGetContent:function(){return this.BtResetFilter(),new wp.media.view.BtTemplates({controller:this.frame,model:this,collection:this.get("library"),selection:this.get("selection"),type:this.get("type")})},BtAddTemplate:function(b){var c=this;PJ_Page_Builder.fixInputValues(a("#page-builder"));var d={};d.builder=a("div.pb-active-row","#pb-rows").find(":input").serialize(),d=_.defaults(d,{type:c.get("type"),template_name:b.template_name,template_desc:b.template_desc});var e=c.get("library").items.add({label:b.template_name,description:b.template_desc,uploading:!0,percent:35});c.get("selection").reset(e),wp.ajax.post("bt_save_template",d).done(function(a){var b=c.get("library"),d=b.findWhere({id:e.id});e.set(a),e.set("uploading",!1),d.set(a),d.set("uploading",!1),c.get("selection").reset(e)}).fail(function(a){e.destroy()})},btImportTemplate:function(){var a=this.get("selection").single().id,b=this.get("type");PJ_Page_Builder.importTemplate(a,b)}})}(jQuery),function(a){"use strict";wp.media.controller.BtTemplates.Library=Backbone.Collection.extend({props:new Backbone.Model({group:"all",search:""}),initialize:function(a){this.items=new Backbone.Collection(a),this.listenTo(this.items,"add update remove reset",this.reInitialize)},reInitialize:function(){var a=this,b=this.items.toJSON(),c=this.props.toJSON();_.each(c,function(c,d){a.filters[d]&&(b=_.filter(b,a.filters[d],c.toLowerCase()))},this),this.reset(b)},filters:{group:function(a){var b=this;return"all"===b||a.group===b||""===a.group},search:function(a){var b,c=this;return b=""===c?!0:_.any(["id","label"],function(b){var c=(a[b]+"").toLowerCase();return c&&-1!==c.search(this)},c)}}})}(jQuery),function(a,b){"use strict";wp.media.controller.BtTemplates.Save=wp.media.controller.State.extend({defaults:{id:"bt-save",menu:"default",title:b.PojoBtTemplates.l10n.save_template,content:"bt-save-template",toolbar:"bt-save-template"},initialize:function(){this.model=this.model||new Backbone.Model},activate:function(){this.frame.on("open",this.refresh,this)},deactivate:function(){this.frame.off("open",this.refresh,this)},refresh:function(){},btGetContent:function(){return new wp.media.view.BtTemplates.Save({controller:this.frame,model:this.model})}})}(jQuery,window),function(a){"use strict";wp.media.view.BtTemplates=wp.media.View.extend({className:"attachments-browser bt-items-wrap",initialize:function(){this.createToolbar(),this.createLibrary(),this.createSidebar()},createLibrary:function(){this.items=new wp.media.view.BtTemplates.Library({controller:this.controller,collection:this.collection,selection:this.options.selection,type:this.options.type,data:this.options.data}),this.views.add(this.items)},createToolbar:function(){this.collection;this.toolbar=new wp.media.view.Toolbar({controller:this.controller}),this.views.add(this.toolbar),this.toolbar.set("search",new wp.media.view.Search({controller:this.controller,model:this.collection.props,priority:60}).render())},createSidebar:function(){var a=this.options,b=a.selection,c=this.sidebar=new wp.media.view.Sidebar({controller:this.controller,type:a.type});this.views.add(c),b.on("selection:single",this.createSingle,this),b.on("selection:unsingle",this.disposeSingle,this),b.single()&&this.createSingle()},createSingle:function(){var a=this.sidebar,b=this.options.selection.single();a.set("details",new wp.media.view.BtTemplates.Deatils({controller:this.controller,model:b,type:this.options.type,data:this.options.data,priority:80}))},disposeSingle:function(){var a=this.sidebar;a.unset("details")}})}(jQuery),function(a){"use strict";wp.media.view.BtTemplates.Deatils=wp.media.View.extend({initialize:function(){this.template=wp.template("bt-template-"+this.options.type+"-sidebar"),wp.media.View.prototype.initialize.apply(this,arguments)},render:function(){var a=_.defaults(this.model.toJSON(),this.options.data);this.$el.html(this.template(a))}})}(jQuery),function(a){"use strict";wp.media.view.BtTemplates.Library=wp.media.View.extend({tagName:"ul",className:"attachments bt-items clearfix",initialize:function(){this._viewsByCid={},this.collection.on("reset",this.refresh,this),this.collection.items.on("btBeforeFetch",this.renderLoading,this),this.controller.on("open",this.scrollToSelected,this)},render:function(){return this.$("span.bt-loading").remove(),this.collection.each(function(a){this.views.add(this.renderItem(a),{at:this.collection.indexOf(a)})},this),this},renderLoading:function(){this.clearItems(),this.$el.html('<span class="bt-loading">Loading..</span>')},renderItem:function(a){var b=new wp.media.view.BtTemplates.Item({controller:this.controller,model:a,collection:this.collection,selection:this.options.selection,type:this.options.type,data:this.options.data});return this._viewsByCid[b.cid]=b},clearItems:function(){_.each(this._viewsByCid,function(a){delete this._viewsByCid[a.cid],a.remove()},this)},refresh:function(){this.clearItems(),this.render()},ready:function(){this.scrollToSelected()},scrollToSelected:function(){var a,b=this.options.selection.single();b&&(a=this.getView(b),a&&!this.isInView(a.$el)&&this.$el.scrollTop(a.$el.offset().top-this.$el.offset().top+this.$el.scrollTop()-parseInt(this.$el.css("paddingTop"))))},getView:function(a){return _.findWhere(this._viewsByCid,{model:a})},isInView:function(b){var c=a(window),d=c.scrollTop(),e=d+c.height(),f=b.offset().top,g=f+b.height();return e>=g&&f>=d}})}(jQuery),function(a){"use strict";wp.media.view.BtTemplates.Filters=wp.media.view.AttachmentFilters.extend({createFilters:function(){this.filters={all:{text:"Select All",props:{group:"all"}}};var a=this.controller.state().get("data").groups;_.each(a,function(a,b){this.filters[b]={text:a,props:{group:b}}},this)},change:function(){var a=this.filters[this.el.value];a&&this.model.set("group",a.props.group)}})}(jQuery),function(a){"use strict";wp.media.view.BtTemplates.Item=wp.media.view.Attachment.extend({className:"attachment bt-item",events:{"click .attachment-preview":"toggleSelectionHandler","click a":"preventDefault"},initialize:function(){this.template=wp.template("bt-template-"+this.options.type+"-item"),wp.media.view.Attachment.prototype.initialize.apply(this,arguments)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.updateSelect(),this}})}(jQuery),function(a){"use strict";wp.media.view.BtTemplates.Save=wp.media.view.Settings.extend({template:wp.template("bt-template-local-add"),events:{"keyup input":"updateHandler"},initialize:function(){wp.media.view.Settings.prototype.initialize.apply(this,arguments),_.extend(this.events,wp.media.view.Settings.prototype.events),this.update("label")}}),wp.media.view.BtTemplates.Save.Toolbar=wp.media.view.Toolbar.Select.extend({initialize:function(){wp.media.view.Toolbar.Select.prototype.initialize.apply(this,arguments),this.listenTo(this.controller.state().model,"change",this.refresh)},refresh:function(){var a=this.controller.state().model.get("label");this.get("select").model.set("disabled",!a),wp.media.view.Toolbar.Select.prototype.refresh.apply(this,arguments)}})}(jQuery),function(a,b){"use strict";var c=Backbone.Collection.prototype.fetch;Backbone.Collection.prototype.fetch=function(){return this.trigger("btBeforeFetch"),c.apply(this,arguments)},b.PojoBtTemplates=_.defaults({frame:"",currentItem:{}},b.PojoBtTemplates),wp.media.view.MediaFrame.BtApp=wp.media.view.MediaFrame.extend({initialize:function(){wp.media.view.MediaFrame.prototype.initialize.apply(this,arguments),_.defaults(this.options,{selection:[],multiple:!1,editing:!1,toolbar:"bt-select"}),this.BtItems=new wp.media.model.BtItems,this.createStates(),this.bindHandlers()},BtInitialize:function(){this.BtUpdateTemplateItems(),this.setState("bt-local")},createStates:function(){var a,c=this.options;c.states||(_.each(b.PojoBtTemplates.types,function(d,e){return wp.media.controller.hasOwnProperty(d.data.controller)?(a=wp.media.controller[d.data.controller],_.defaults(d,{content:d.id,selection:c.selection}),void this.states.add(new a(d))):void delete b.PojoBtTemplates.types[e]},this),this.states.add(new wp.media.controller.BtTemplates.Save({priority:120})))},BtRenderContent:function(){var a=this.state(),b=this.content.mode(),c=a.btGetContent(b);this.content.set(c)},BtGetCurrentItem:function(){return this.BtItems.get(b.PojoBtTemplates.currentItem.id)},BtUpdateTemplateItems:function(){var a=this.BtGetCurrentItem();_.isUndefined(a)?this.BtItems.add(b.PojoBtTemplates.currentItem):a.set(b.PojoBtTemplates.currentItem),this.BtItems.props.set("item",b.PojoBtTemplates.currentItem.id)},bindHandlers:function(){this.on("router:create:browse",this.createRouter,this),this.on("router:render:browse",this.browseRouter,this),this.on("content:render",this.BtRenderContent,this),this.on("toolbar:create:bt-select",this.createToolbar,this),this.on("toolbar:render:bt-select",this.BtSelectToolbar,this),this.on("toolbar:create:bt-save-template",this.BtSaveTemplateToolbar,this),this.on("menu:render",this.BtRenderMenu,this),this.on("open",this.BtInitialize,this)},BtSelectToolbar:function(a){var c=this,d=c.state();d.get("type");a.set(d.id,{style:"primary",priority:80,text:b.PojoBtTemplates.l10n.insert_template,controller:d.get("library").items,requires:{selection:!0},click:function(){c.close(),d.btImportTemplate()}})},BtRenderMenu:function(a){a.set({"templates-separator":new wp.media.View({className:"separator",priority:100})})},BtSaveTemplateToolbar:function(a){var c=this;a.view=new wp.media.view.BtTemplates.Save.Toolbar({controller:c,items:{select:{text:b.PojoBtTemplates.l10n.save_template,style:"primary",click:function(){var a=c.state().model,b=a.get("label"),d=a.get("description"),e=c.state("bt-local");e.BtAddTemplate({template_name:b,template_desc:d}),c.close()}}}})}}),a("a.open-template-media").on("click",function(c){c.preventDefault(),b.PojoBtTemplates.currentItem={id:100,title:""},b.PojoBtTemplates.frame instanceof wp.media.view.MediaFrame.BtApp||(b.PojoBtTemplates.frame=new wp.media.view.MediaFrame.BtApp),b.PojoBtTemplates.frame.open(),void 0!==a(this).data("target")&&b.PojoBtTemplates.frame.setState(a(this).data("target"))})}(jQuery,window);